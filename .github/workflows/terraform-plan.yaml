name: "Terraform Plan"

on:
  pull_request:

env:
  SSH_PRIVATE_KEY_PATH: "~/.ssh/id_rsa"

jobs:
  terraform:
    name: "Terraform Plan"
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -input=false

      - name: Setup ssh key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ${{ env.SSH_PRIVATE_KEY_PATH }}
          chmod 600 ~/.ssh/id_rsa

      - name: Test
        env:
          TEST_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEST_SECRET: ${{ secrets.TEST_SECRET }}
        run: |
          echo ${#TEST_GITHUB_TOKEN}
          echo ${#TEST_SECRET}

      - name: Terraform Plan
        run: |
          export TF_VAR_cluster=${{ secrets.PG_CONN_STR }}
          terraform plan -var="cluster=${{vars.CLUSTER}}" -var="host_name_base=${{vars.HOST_NAME_BASE}}" -var="cf_dns_api_token=${{secrets.CF_DNS_API_TOKEN}}" -var="ssh_key=${{env.SSH_PRIVATE_KEY_PATH}}" -input=false -out=tfplan
        env:
          PG_CONN_STR: ${{ secrets.PG_CONN_STR }}
          SSH_PRIVATE_KEY_PATH: ${{ env.SSH_PRIVATE_KEY_PATH }}
